{% extends "base.html" %}
{% block title%}{{title}}{% endblock %}

{% block content %}
<style>
	input, textarea { display:block;}
	#story , #story_list {margin-top:15px;}
	#story {float:left; width:500px;height:400px;border:1px solid #ccc; background:#000;}
	#story_list { background:url({{STATIC_URL}}images/bg-story-sort.jpg) no-repeat; float:left; width:130px; height:400px;border:1px solid #ccc;}
	
	#hair, #cloth, #eye, #face, #glass_left, #other1_left, #other2_left, #other3_left {
		margin-left:140px;
	    width: 267px;
	    height: 400px;
	    position: absolute;
	    background-repeat: no-repeat;
	}
	#face {z-index: 2}
	#eye {z-index: 2}
	#hair {z-index: 1}
	#role_image { height:400px; width:500px;}

	#dialog {
		z-index:11;
		width: 400px;
		height:70px;
		background:#c6c6c6;
		position: absolute;
		margin:280px 0 0 30px;
		border-radius:5px;
		-webkit-border-radius:5px;
		opacity:0.5;
		padding:20px;
		font-size:14px;
		color:#000;
		text-shadow:rgba(0, 0, 0, 0.3) 0 -1px 0;
		font-family: '黑体';
	}
	#dialog p { opacity:1;}
	
	#process_frame { width:200px;height:200px;background:#c6c6c6;overflow:hidden; text-overflow	:ellipsis; }
	#process_frame li:nth-child(odd) { background:#fff;text-overflow: ellipsis; }
</style>
</head>
{{command|safe}}
{{role.name}}


	<div id="story" style="background:url('{{ STATIC_URL }}bgd/mapback.jpg');" >
		<div id="hair"></div>
		<div id="eye"></div>
		<div id="face"></div>
		<div id="cloth"></div>
		<div id="dialog" onclick="run()"></div>
		<div id="role_image"></div>
	</div>
{% endblock%}

{% block js %}
<script>
	var i = 0;
	var commandJson = $.parseJSON('{{command|safe}}');
	var process = commandJson.process
	
	function clear_role()
	{
		role_dom = ['cloth', 'hair', 'face', 'eye'];
		for (var i in role_dom) $("#"+role_dom[i]).attr('style','');
		$("#role_image").attr('style','');
		$('#role_user option:first, #role_default option:first').attr('selected','selected');
	}
	
	function change_role(type, value)
	{
		var value = value/1;
		var role_dom = [];
		var role_profile = [];
		var el = document.getElementById('process_frame');
		{% for role in role_list %}
		{% if role.image %}
		role_profile[{{role.id}}] = '{{ role.image }}';
		{% else %}
		role_profile[{{role.id}}] = [{{ role.profile|safe }}];
		{% endif %}
		{% endfor %}
		role_dom = ['cloth', 'hair', 'face', 'eye'];
		
		if (type == 'default')
		{
			if (value !=0)
			{
				for (var i in role_dom) $("#"+role_dom[i]).attr('style',role_profile[value][i]);
				$("#role_image").attr('style','');
			}
			else clear_role();
		}
		else
		{
			if (value !=0)
			{
				for (var i in role_dom) $("#"+role_dom[i]).attr('style','');
				$("#role_image").attr('style',"background:url('/"+role_profile[value]+"') no-repeat center bottom");
				var role_image = $('#role_image').attr('style');
			}
			else clear_role();
		}
	}
	
	
	function run()
	{
		switch(process[i].type) 
		{
			case 'BGD':
			    $('#story').attr('style','background:url('+process[i].value+')');
				break;
			case 'DROLE':
			    change_role('default',process[i].value);
				break;
			case 'UROLE':
			    change_role('user',process[i].value);
				break;
			case 'ROLE':
			    clear_role();
				break;
			case 'DIALOG':
			    $("#dialog").text(process[i].value);
				break;
			default: 
				alert('这条流程没办法解析呀╮(╯_╰)╭');
				break;
		}
		i++;
	};
</script>
{% endblock %}