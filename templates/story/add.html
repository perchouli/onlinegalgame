{% extends "base.html" %}
{% block title%}添加故事{% endblock %}

{% block content %}


<style>
	input, textarea { display:block;}
	
	#hair_left, #cloth_left, #eye_left, #face_left, #glass_left, #other1_left, #other2_left, #other3_left {
		margin-left:-30px;
	    width: 267px;
	    height: 400px;
	    position: absolute;
	    background-repeat: no-repeat;
	}
		#cloth_left {z-index: 3} 
		#hair_left {z-index: 4}
		#eye_left {z-index: 8}
		#face_left {z-index: 10;}

	#hair_right, #cloth_right, #eye_right, #face_right, #glass_right, #other1_right, #other2_right, #other3_right {
		margin-left:230px;
	    width: 267px;
	    height: 400px;
	    position: absolute;
	    background-repeat: no-repeat;
	}
		#cloth_right {z-index: 3} 
		#hair_right {z-index: 4}
		#eye_right {z-index: 8}
		#face_right {z-index: 10;}

	#glass {z-index: 7}
	#other1 {z-index: 7}
	#other2 {z-index: 7;}
	#other3 {z-index: 7;}
	
	#dialog {
		z-index:11;
		width: 400px;
		height:70px;
		background:#c6c6c6;
		position: absolute;
		margin:280px 0 0 30px;
		border-radius:5px;
		-webkit-border-radius:5px;
		opacity:0.5;
		padding:20px;
		font-size:14px;
		color:#000;
		text-shadow:rgba(0, 0, 0, 0.3) 0 -1px 0;
		font-family: '黑体';
	}
	#trash li {display:none;}
	#trash span {display:none;}
	#process_frame { width:200px;height:200px;background:#c6c6c6;overflow:hidden; text-overflow	:ellipsis; }
	#process_frame li:nth-child(odd) { background:#fff;text-overflow: ellipsis; }
</style>
</head>


 <!--START: left-nav -->
<div class="sidebar">
	<h2 class="title" >Basic Info</h2>
	<form id="story_form" action="{%url add_story %}" method="POST">
		{% csrf_token %}
	<ul>
		<li>
			title:<br/><input type="text" name="title" id="title"/>
		</li>
		<li>
			summary:<br/><textarea id="summary" name="summary"></textarea>
		</li>
		<li>
			关系:<br/><input type="text" name="relation" id="relation" style="width:100px"/>
		</li>
		<li>
<div id="process_frame" ondrop="drop(this)" ondragenter="return false" ondragover="return false">
	<!--不能使用ondragend -->
</div>

<div id="trash" ondrop="drop(this)" ondragenter="return false" ondragover="return false" style="background:#000; width:50px; height:50px;"></div>

		</li>
		<li>
			<input type="hidden" id="process" name="process" value="" />
			<p><input type="button" value="Submit" onclick="validator_story_from()"  /></p>
		</li>
	</ul>
	</form>
	<h2 class="title" >Your roles</h2>
	<ul>
		{% for role in my_role_list %}
		<li></li>
		{% endfor %}
	</ul>
</div>
 <!--END: left-nav -->
	
	
<script>
	function drag(source) {
		event.dataTransfer.setData('Text',source.id);
	}
	function drop(target) {
		v = event.dataTransfer.getData('Text');
		target.appendChild(document.getElementById(v));
	}	
	
	function add_dialog(id)
	{
		var  dia_content = document.getElementById('dialog_input').value;
		dia_content = dia_content.replace(',','，');
		var el = document.getElementById('process_frame');
		el.innerHTML += '<li data-type="DIALOG" data-value="'+dia_content+'" draggable="true">'+dia_content+'</li>';

	}
	
	function change_role( pos, value)
	{
		var role_dom = [];
		var role_profile = [];
		if (pos == 1)
		{
			var el = document.getElementById('process_frame');
			role_dom = ['cloth_left', 'hair_left', 'face_left', 'eye_left'];
			var process = document.querySelectorAll('#process_frame li');
			el.innerHTML += '<li id="p'+process.length+'" data-type="LEFTROLE" data-value="'+value+'" draggable="true" dropzone="move" ondragstart="drag(this)">修改左侧角色</li>';
			
		}
		else
		{
			var el = document.getElementById('process_frame');
			role_dom = ['cloth_right', 'hair_right', 'face_right', 'eye_right'];
			el.innerHTML += '<li data-type="RIGHTROLE" data-value="'+value+'" draggable="true" dropzone="move">修改右侧角色</li>';
		}
		{% for role in role_list %}
		role_profile[{{role.id}}] = [{{ role.profile|safe }}];
		{% endfor %}
		for (var i in role_dom)
		{
			
			var el = document.getElementById(role_dom[i]);
			el.setAttribute("style",role_profile[value][i]);
		}	
	}
	
	
	function validator_story_from()
	{
				
		var process = document.querySelectorAll('#process_frame li');
		
		var process_value = [];
		for (var i=0 ;i < process.length;i++)
		{
			var type = process[i].dataset['type'];

			    process_value[i] = type+'|'+(process[i].dataset['value']);
		}
		
		document.getElementById('process').value = process_value;
		document.getElementById('story_form').submit();
	}
	
	var i = 0;
	
	function run()
	{
		switch(i) 
		{
			case 0:
			    document.getElementById('dialog').innerText = 'test';
				break;
			case 1:
			    document.getElementById('dialog').innerHTML = '<span style="color:red">test</span>';
				break;
			default: 
				alert ('Story has end');
		}
		i ++;
	}
</script>
<div>
对话：
<input id="dialog_input" type="text" /> <input type="button" value="添加对话" onclick="add_dialog(this.id)" />


左侧人物：
<select name="role" onchange="change_role(1,this.value)">
<option value="">未选择</option>
{% for role in role_list %}
	<option value='{{ role.id }}'> {{ role.name }}</option>
{% endfor %}
</select>

右侧人物：
<select name="role" onchange="change_role(2,this.value)">
<option value="">未选择</option>
{% for role in role_list %}
	<option value='{{ role.id }}'> {{ role.name }}</option>
{% endfor %}
</select>
</div>

<div>
短发:
<select name="hair" onchange="change_role(this.name,this.value)">
	<option value="1">短发</option>
	<option value="2">女仆装</option>
	<option value="3">女仆装</option>
</select>

长发:
<select name="hair" onchange="change_role(this.name,this.value)">
	<option value="1">短发</option>
	<option value="2">女仆装</option>
	<option value="3">女仆装</option>
</select>
</div>
	<div id="role" style="background:url('{{ STATIC_URL }}bgd/mapback.jpg');margin-top:50px;width:500px;height:400px;border:1px solid #ccc;" >
		<div id="hair_left"></div>
		<div id="eye_left"></div>
		<div id="face_left"></div>
		<div id="cloth_left"></div>

		<div id="dialog" onclick="run()"></div>
		
		<div id="hair_right"></div>
		<div id="eye_right"></div>
		<div id="face_right"></div>
		<div id="cloth_right"></div>
	</div>

{% endblock %}